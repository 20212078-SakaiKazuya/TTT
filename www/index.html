<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <!-- ページタイトル -->
    <title>オリジナルマップの作成</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/drawer.css" />
    <link rel="stylesheet" href="css/transition.css" />
    <!-- leaflet.css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <!-- leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <!-- ニフクラ -->
    <script src="components/loader.js"></script>
    <script>
        // ニフクラ接続
        var applicationKey = '31f236de7d5148a5cb93c53b52bfdd0fb4469aa6a3f4f0e8a39afa23f917241e';
        var clientKey = 'b59e281093d74f2fcb80e83a1aaf70d106e73e6059b429e5f39298a9884ae771'
        var ncmb = new NCMB(applicationKey, clientKey);
        var reader = new FileReader();  //画像読み込み
        // クラス,変数定義
        var pin = ncmb.DataStore("pin");
        var album = ncmb.DataStore("alubum");
        var picture = ncmb.DataStore("picture");
        var pinList = [];
        var pictureList = [];
        var albumList = [];
        var userId;
        // ユーザー情報取得
        // var currentUser = ncmb.User.getCurrentUser();
        // if(currentUser) {
        //     console.log("ログイン中のユーザーID：" + currentUser.get("userId"));
        //     userId = currentUser.get("userId");     // ログインしているユーザーIDの取得
        // } else {
        //     console.log("未ログインまたは取得に失敗");
        //     window.location.href = 'login.html';
        // }
        // ピン情報取得
        pinList = pin.fetchById(userId)
                    .then(pinList =>{
                        console.log("データあり");
                    })
                    .catch(e =>{
                        console.log("データなし");
                    });
        // ユーザーの写真を取得
        pictureList = picture.fetchById(userId)
                    .then(pictureList =>{
                        console.log("データあり");
                    })
                    .catch(e =>{
                        console.log("データなし");
                    });
        // ユーザーのアルバムを取得
        albumList = album.fetchById(userId)
                    .then(albumList =>{
                        console.log("データあり");
                    })
                    .catch(e =>{
                        console.log("データなし");
                    });

    </script>

</head>

<body>

    <!-- 地図を表示するブロック要素 -->
    <div id="mymap" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
    <!-- モーダル -->
    <div id="drawerNavi" class="overlay">
        <div id="drawerClose"><span class="lineClose"></span></div>
        <ul class="overlay-content">
            <li>
                <img src="images/bookmark.png" onclick="transition('curry.html');">
            </li>
            <li>
                <img src="images/pin.png" onclick="transition('pin.html');">
            </li>
            <li>
                <img src="images/album.png" onclick="transition('album.html');">
            </li>
            <li>
                <img src="images/setting.png" onclick="transition('setting.html');">
            </li>
            <li>
                <a href="#"></a>
            </li>
        </ul>
        <img class="tenki" src="images/tenkiOn.png" onclick="tenki(this);">
    </div>

    <div id="transform" class="transition"></div>

    <img src="images/snake_burger.png" id="drawerOpen" style="position:absolute;top:0;left:0;z-index:1000;width:20%;">

    <img src="images/eye.png" style="position:absolute;top:0;right:0;z-index:1000;width:20%;" onclick="currentLocation();">

    <img class="none" src="images/indian.png" style="position:absolute;bottom:0;left:0;z-index:1000;width:20%;">
    <div id="meteo" class="none" style="position:absolute;bottom:20px;right:20px;z-index:1000; background-color:white; width:70%; height:10%; font-size:50px;border-radius:10px;">
    </div>
    <div class="none" style="position:absolute;z-index:999;width:10%;height:5%;bottom:3%;left:27%;background-color:white;transform:rotate(45deg);"></div>

    <!-- デバッグ用 -->
    <div style="position:absolute;z-index:1000;left:30%;top:0">
        <a href="login.html">ログイン画面へ</a>
    </div>

    <script>
        document.getElementById('drawerOpen').addEventListener('click', () => {
            document.getElementById("drawerNavi").style.width = "60%";
        });

        document.getElementById('drawerClose').addEventListener('click', () => {
            document.getElementById("drawerNavi").style.width = "0%";
        });
    </script>

    <script>
        function transition(url) {
            document.getElementById('transform').style.width = "100%";
            setTimeout(transLocation, 200, url);
        }
        function transLocation(url) {
            window.location.href = url;
        }

        var tenkiChk = true;

        function tenki(tenki) {
            if (tenki.src.substring(tenki.src.length - 18, tenki.src.lengh) == 'images/tenkiOn.png') {
                tenki.src = 'images/tenkiOff.png';
                tenkiChk = false;
            } else {
                tenki.src = 'images/tenkiOn.png';
                tenkiChk = true;
            }
        }

        var mymap = L.map("mymap", {
            zoomControl: false
        });
        first = 0;
        var marklatlng;

        /* アイコンの設定 */
        var genzai = L.icon({
            iconUrl: 'images/30264.png',
            iconRetinaUrl: 'images/30264.png',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -50],
        });

        /* 緯度・経度と倍率の指定 */
        function onLocationFound(e) {
            marklatlng = e.latlng;
            if (first == 0) {
                mymap.setView([e.latlng.lat, e.latlng.lng], 18);
                mark = L.marker(e.latlng, {
                    icon: genzai
                }).addTo(mymap);
                mark._icon.id = 'mark';
                first++;
            } else {
                mark.setLatLng(e.latlng);
            }
        }

        function start() {
            setInterval(locat, 1000);
        }

        function locat() {
            mymap.locate({
                setView: false,
                maxZoom: 18
            });
        }

        window.addEventListener('load', start);

        function onLocationError(e) {}
        mymap.on('locationfound', onLocationFound);
        mymap.on('locationerror', onLocationError);

        function currentLocation() {
            mymap.setView(marklatlng, 18);
        }



        /* 地図タイルとクレジット表示 */
        L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors",
            maxZoom: 20,
            maxNativeZoom: 18
        }).addTo(mymap);

        /* マーカー表示 */
        data = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [141.37970483779569, 43.05595115422]
                },
                "properties": {
                    "name": "北海道情報専門学校",
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [136.985318, 35.162474]
                },
                "properties": {
                    "name": "星ヶ丘駅",
                }
            }]
        }

        /* GeoJSONの読込 */
        L.geoJSON(data, {
            onEachFeature: function(feature, layer) {
                layer.bindPopup("<div style='width:200px'>" + feature.properties.name + "</div>");
            }
        }).addTo(mymap);

        /* イベント処理 */
        var popup = L.popup();
        var chk = false;

        function onMapClick(e) {
            if (!chk) {
                newPop = popup.setLatLng(e.latlng).setContent(
                    "<p>この場所にピンを立てますか？</p><br><button style='width:100%;height:40px;' onclick='clickMarker(" + e.latlng.lat + "," + e.latlng.lng + ");'>YES"
                ).openOn(mymap);
                chk = true;
            } else {
                chk = false;
            }
        }

        var click = mymap.on('click', onMapClick);

        function clickMarker(la, ln) {
            newPin = L.marker([la, ln]).addTo(mymap);
            newPop.remove();

            newPin.bindPopup("<div style='width:200px'>新規ピン</</div>");

            chk = false;
        }

        mymap.on('popupopen', function() {
            if (tenkiChk) {
                var request = new XMLHttpRequest();
                var lat = click._popup._latlng.lat;
                var lng = click._popup._latlng.lng;

                request.open('GET', 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lng + '&hourly=weathercode&models=best_match&timezone=auto', true);
                request.responseType = 'json';

                request.onload = function() {
                    var data = this.response;
                    var code = data['hourly']['weathercode'][0];
                    var tag = document.getElementById('meteo');
                    tag.innerText = '今この場所は' + weathercodes[code];

                    var ind = document.getElementsByClassName('none');
                    for (i = 0; i < ind.length; i++) {
                        ind[i].style.display = 'block';
                    }
                };

                request.send();
            }
        });
        mymap.on('popupclose', function() {
            var ind = document.getElementsByClassName('none');
            for (i = 0; i < ind.length; i++) {
                ind[i].style.display = 'none';
            }
            var tag = document.getElementById('meteo');
            tag.innerText = "";
        });

        window.addEventListener('load', function() {
            var request = new XMLHttpRequest();

            request.open('GET', 'weathercode.json');
            request.responseType = 'json';

            request.onload = function() {
                weathercodes = this.response;
            };

            request.send();
        });
    </script>
</body>

</html>