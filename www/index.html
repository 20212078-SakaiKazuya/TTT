<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <!-- ページタイトル -->
    <title>オリジナルマップの作成</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/drawer.css" />
    <!-- leaflet.css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <!-- leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>

<body>

    <!-- 地図を表示するブロック要素 -->
    <div id="mymap" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>

    <div id="drawerNavi" class="overlay">
        <div id="drawerClose"><span class="lineClose"></span></div>
        <ul class="overlay-content">
            <li>
                <a href="pin.html"><img src="images/bookmark.png"></a>
            </li>
            <li>
                <a href="pin.html"><img src="images/pin.png"> </a></li>
            <li>
                <a href="pin.html"><img src="images/album.png"> </a></li>
            <li>
                <a href="#"></a>
            </li>
        </ul>
    </div>

    <img src="images/snake_burger.png" id="drawerOpen" style="position:absolute;top:0;left:0;z-index:1000;width:20%;">

    <img src="images/eye.png" style="position:absolute;top:0;right:0;z-index:1000;width:20%;" onclick="currentLocation();">

    <script>
        document.getElementById('drawerOpen').addEventListener('click', () => {
            document.getElementById("drawerNavi").style.width = "60%";
        });

        document.getElementById('drawerClose').addEventListener('click', () => {
            document.getElementById("drawerNavi").style.width = "0%";
        });
    </script>

    <script>
        var mymap = L.map("mymap", {zoomControl: false});
        cnt = 0;
        var marklatlng;

        /* アイコンの設定 */
        var genzai = L.icon({
            iconUrl: 'images/30264.png',
            iconRetinaUrl: 'images/30264.png',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -50],
        });

        /* 緯度・経度と倍率の指定 */
        function onLocationFound(e) {
            marklatlng = e.latlng;
            if (cnt == 0) {
                mymap.setView([e.latlng.lat, e.latlng.lng], 18);
                mark = L.marker(e.latlng, {icon: genzai}).addTo(mymap);
                mark._icon.id = 'mark';
            } else {
                mark.setLatLng(e.latlng);
            }
            cnt++;
        }

        function start() {
            console.log('hello');
            setInterval(locat, 1000);
        }

        function locat() {
            mymap.locate({setView: false,maxZoom: 18});
        }

        window.addEventListener('load', start);

        function onLocationError(e) {}
        mymap.on('locationfound', onLocationFound);
        mymap.on('locationerror', onLocationError);

        function currentLocation(){
            mymap.setView(marklatlng, 18);
        }



        /* 地図タイルとクレジット表示 */
        L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors",
            maxZoom: 20,
            maxNativeZoom: 18
        }).addTo(mymap);

        /* マーカー表示 */
        data = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [141.37970483779569, 43.05595115422]
                },
                "properties": {
                    "name": "北海道情報専門学校",
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [136.985318, 35.162474]
                },
                "properties": {
                    "name": "星ヶ丘駅",
                }
            }]
        }

        /* GeoJSONの読込 */
        L.geoJSON(data, {
            onEachFeature: function(feature, layer) {
                layer.bindPopup("<div style='width:200px'>" + feature.properties.name + "</div>");
            }
        }).addTo(mymap);

        /* イベント処理 */
        var popup = L.popup();

        function onMapClick(e) {
            newPin = popup.setLatLng(e.latlng).setContent(
                "<p>この場所にピンを立てますか？</p><br><button style='width:100%;height:40px;' onclick='clickMarker(" + e.latlng.lat + "," + e.latlng.lng + ");'>YES"
            ).openOn(mymap);
        }

        mymap.on('click', onMapClick);

        function clickMarker(la,ln) {
            L.marker([la, ln]).addTo(mymap);
            newPin.remove();
        }
    </script>
</body>

</html>